# 🔧 项目调试说明

## 📋 项目当前状态

### ✅ 已完成
- 项目结构已创建
- 所有依赖已安装
- 开发服务器已启动（`npm run dev`）
- 所有 TypeScript 类型错误已修复
- AI 服务已兼容 Ollama

### 🌐 访问地址
**http://localhost:3000**

---

## 🐛 调试指南

### 1. 检查服务器状态

#### 方法 A: 浏览器访问
直接在浏览器打开 `http://localhost:3000`

**预期结果**:
- ✅ 看到项目标题："AI+中国优秀传统文化"
- ✅ 看到操作说明面板
- ✅ 3D 场景正常加载

**如果失败**:
- 检查控制台错误（F12）
- 查看网络请求是否有失败

#### 方法 B: 命令行检查
```powershell
# 检查端口是否被占用
netstat -ano | findstr :3000

# 如果看到结果，说明服务正在运行
```

---

### 2. 常见问题排查

#### 问题 1: 页面无法访问

**症状**: 浏览器显示"无法访问此网站"

**解决步骤**:
```powershell
# 1. 确认服务器是否在运行
# 查看当前目录的后台进程

# 2. 如果服务器没有运行，重新启动
npm run dev

# 3. 等待看到类似信息：
# VITE v5.x.x ready in xxx ms
# ➜ Local:   http://localhost:3000/
```

#### 问题 2: 黑屏或白屏

**症状**: 页面打开但是空白

**解决步骤**:
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签页的错误信息
3. 查看 Network 标签页，确认资源是否加载成功

**常见错误**:
- `Failed to load module` - 依赖加载失败
  - 解决: 重新安装依赖 `npm install`
  
- `WebGL not supported` - 浏览器不支持 WebGL
  - 解决: 更换浏览器或更新显卡驱动

#### 问题 3: TypeScript 错误

**症状**: 终端显示类型错误

**解决步骤**:
```powershell
# 1. 清理构建缓存
Remove-Item -Recurse -Force node_modules/.vite

# 2. 重启开发服务器
# 按 Ctrl+C 停止，然后
npm run dev
```

#### 问题 4: AI 对话无响应

**症状**: 走近文物没有 AI 讲解

**排查步骤**:

1. **检查控制台日志**
   - 打开 F12
   - 看是否有 "未配置AI API Key，使用模拟回复" 消息
   - 这是正常的，说明在使用内置模拟回复

2. **如果使用 Ollama**
   ```powershell
   # 测试 Ollama 是否在运行
   curl http://localhost:11434/api/tags
   
   # 应该返回模型列表
   ```

3. **检查 .env 配置**
   - 确认 `.env` 文件存在
   - 检查配置是否正确

---

### 3. 开发者工具使用

#### 浏览器控制台（F12）

**Console 标签**:
- 查看 JavaScript 错误
- 查看 console.log 输出
- 查看 AI API 相关日志

**重要日志**:
```
未配置AI API Key，使用模拟回复  // 正常，使用模拟回复
AI API 调用失败: ...              // 如果配置了 API 但失败
```

**Network 标签**:
- 查看资源加载状态
- 查看 API 请求（如果配置了真实 AI）
- 检查 3D 模型加载

**Sources 标签**:
- 设置断点调试
- 查看源代码

---

### 4. 性能调试

#### 开发模式性能监控

项目在开发模式下已启用性能监控（右上角的 Stats 面板）：

- **FPS**: 帧率（应该 > 30）
- **MS**: 每帧耗时（应该 < 33ms）
- **MB**: 内存使用

**如果 FPS 很低**:
1. 减少场景复杂度
2. 关闭阴影（在 Scene.tsx 中）
3. 降低材质质量

#### 使用 React DevTools

```powershell
# 在浏览器中安装 React DevTools 扩展
# Chrome: https://chrome.google.com/webstore
# 搜索 "React Developer Tools"
```

---

### 5. 日志调试

#### 添加调试日志

在关键位置添加 console.log：

**示例 1: 检查玩家位置**
```typescript
// src/components/Experience.tsx
useFrame(() => {
  // ...
  console.log('Player position:', newPosition)
})
```

**示例 2: 检查触发器**
```typescript
// src/components/Experience.tsx
if (distance <= point.radius) {
  console.log('Triggered point:', point.name, 'distance:', distance)
}
```

**示例 3: 检查 AI 响应**
```typescript
// src/services/aiService.ts
export async function getAIResponse(...) {
  console.log('AI Request:', messages)
  // ...
  console.log('AI Response:', response)
}
```

---

### 6. 代码热重载

项目支持热重载（HMR），修改代码后自动刷新：

**支持热重载的文件**:
- ✅ 所有 React 组件
- ✅ CSS 文件
- ✅ TypeScript 文件

**不支持热重载**:
- ❌ `.env` 文件（需要重启服务器）
- ❌ `vite.config.ts`（需要重启）
- ❌ `package.json`（需要重新安装依赖）

---

### 7. 清理和重置

#### 完全重置项目

如果遇到无法解决的问题：

```powershell
# 1. 停止开发服务器（Ctrl+C）

# 2. 删除依赖和缓存
Remove-Item -Recurse -Force node_modules
Remove-Item -Force package-lock.json
Remove-Item -Recurse -Force node_modules/.vite

# 3. 重新安装
npm install

# 4. 启动
npm run dev
```

---

### 8. 构建测试

#### 测试生产构建

```powershell
# 1. 构建生产版本
npm run build

# 2. 预览构建结果
npm run preview

# 3. 访问
# http://localhost:4173
```

**检查构建产物**:
- 查看 `dist/` 目录
- 检查文件大小
- 确认所有资源都被正确打包

---

### 9. 环境配置调试

#### 检查环境变量

```typescript
// 在任意组件中添加
console.log('Environment:', {
  apiKey: import.meta.env.VITE_AI_API_KEY ? '已配置' : '未配置',
  baseURL: import.meta.env.VITE_AI_BASE_URL,
  model: import.meta.env.VITE_AI_MODEL,
  provider: import.meta.env.VITE_AI_PROVIDER,
})
```

#### Ollama 连接测试

```powershell
# 测试 Ollama API
curl http://localhost:11434/api/tags

# 如果失败，检查 Ollama 是否运行
Get-Process ollama

# 如果没有运行，启动 Ollama
# 双击 Ollama 应用程序图标
```

---

### 10. 常用调试工具

#### VS Code 推荐扩展

- **ES7+ React/Redux/React-Native snippets** - React 代码片段
- **TypeScript Vue Plugin (Volar)** - TypeScript 支持
- **Error Lens** - 内联显示错误
- **Console Ninja** - 增强的控制台输出

#### 浏览器推荐扩展

- **React Developer Tools** - React 调试
- **Redux DevTools** - 状态调试（虽然我们用 Zustand）
- **WebGL Inspector** - WebGL 调试

---

## 📊 性能指标参考

### 正常运行指标

- **FPS**: 50-60（桌面端）, 30+（移动端）
- **加载时间**: < 3秒
- **内存使用**: < 200MB
- **首屏渲染**: < 1秒

### 如果低于这些指标

1. 检查是否有大量 console.log
2. 检查是否有内存泄漏
3. 减少场景复杂度
4. 优化材质和纹理

---

## 🔍 详细检查清单

运行项目后，逐项检查：

### 基础功能
- [ ] 页面能正常打开
- [ ] 3D 场景能看到（天空、地面、文物）
- [ ] 点击屏幕能进入第一人称视角
- [ ] 鼠标能控制视角
- [ ] WASD 能移动角色

### 交互功能
- [ ] 走近文物会显示场景信息面板
- [ ] AI 会自动开始讲解
- [ ] 对话框能打开/关闭
- [ ] 能在对话框输入问题
- [ ] AI 能回复（模拟或真实）

### UI 功能
- [ ] 操作说明能显示
- [ ] 场景信息面板样式正常
- [ ] AI 对话面板样式正常
- [ ] 控制按钮能正常工作
- [ ] 准星在屏幕中央

### 性能
- [ ] FPS > 30
- [ ] 没有明显卡顿
- [ ] 内存不会持续增长
- [ ] 控制台没有持续的错误

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. **查看完整错误信息**
   - 截图浏览器控制台的错误
   - 复制完整的错误堆栈

2. **记录复现步骤**
   - 详细描述操作过程
   - 记录触发错误的具体步骤

3. **收集环境信息**
   ```powershell
   node --version
   npm --version
   # 浏览器版本
   # 操作系统版本
   ```

4. **提交 Issue**
   - 包含上述所有信息
   - 附上相关代码片段

---

**祝调试顺利！** 🔧
